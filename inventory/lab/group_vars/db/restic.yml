---
# ============================================================================
# Restic: Backup Configuration
# File: group_vars/db/restic.yml
# Role: roles-ansible.restic
# ============================================================================
#
# This file contains backup configuration for database hosts.
#
# Applied to: All hosts in 'db' group
# Variable precedence: Overrides all/, overridden by hw_* → app/ → host_vars/
# ============================================================================

# --- ROLE: Installation ---
# Download Restic binary from GitHub releases
restic_url: "https://github.com/restic/restic/releases/download/v{{ restic_version }}/restic_{{ restic_version }}_linux_amd64.bz2"
restic_version: "0.18.0"
restic_download_path: "/opt"
restic_install_path: "/usr/local/bin"

# --- ROLE: User Configuration ---
# Run Restic as root for repository access
# Use sudo in stdin_cmd for database access as postgres user
restic_user: "root"
restic_create_user: false

# --- ROLE: Script Directory ---
# Location for backup scripts
restic_script_dir: "/opt/restic"

# --- ROLE: Scheduling ---
# Enable systemd timer-based scheduling
restic_create_schedule: true
restic_schedule_type: "systemd"

# --- ROLE: Repository Configuration ---
restic_repos:
  local:
    location: /var/backups/restic
    password: "{{ restic_local_password }}"
    init: true

# --- ROLE: Backup Configuration ---
# PostgreSQL stdin-based backup using pg_dump
restic_backups:
  testdb:
    # Backup identification
    name: testdb
    repo: local

    # stdin configuration for pg_dump
    stdin: true
    stdin_cmd: sudo -u postgres pg_dump -U postgres -Fc testdb
    stdin_filename: testdb.dump
    src: /dev/null # Dummy value - template requires this even for stdin backups

    # Scheduling
    scheduled: true
    schedule_oncalendar: "*-*-* 02:00:00" # Daily at 2:00 AM

    # Retention policy
    keep_daily: 7 # Keep 7 daily backups
    keep_weekly: 4 # Keep 4 weekly backups
    keep_monthly: 3 # Keep 3 monthly backups

    # Pruning
    prune: true # Enable automatic pruning


# ============================================================================
# Notes:
# - Backup runs as root for repository access
# - stdin_cmd uses sudo to run pg_dump as postgres user for database access
# - stdin_cmd uses pg_dump custom format (-Fc) with built-in compression
# - Retention: 7 days + 4 weeks + 3 months
# - Automatic pruning removes old snapshots per retention policy
# - systemd timer: /etc/systemd/system/restic-backup-testdb.timer
# - src: /dev/null is a workaround for role template bug (not used for stdin)
# ============================================================================
