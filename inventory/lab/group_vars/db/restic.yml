---
# ============================================================================
# Restic: Backup Configuration
# File: group_vars/db/restic.yml
# Role: restic (custom)
# ============================================================================
#
# This file contains backup configuration for database hosts.
#
# Applied to: All hosts in 'db' group
# Variable precedence: Overrides all/, overridden by hw_* → app/ → host_vars/
# ============================================================================

# --- Repository Configuration ---
restic_repository: /var/backups/restic
restic_password: "{{ restic_local_password }}"

# --- Repository Initialization ---
restic_init: true

# --- Repository-level Retention Defaults ---
restic_keep_daily: 7
restic_keep_weekly: 4
restic_keep_monthly: 3

# --- Backup Configurations ---
restic_backups:
  testdb:
    # Backup mode
    stdin: true
    stdin_cmd: sudo -u postgres pg_dump -U postgres -Fc testdb
    stdin_filename: testdb.dump

    # Scheduling
    schedule: "*-*-* 02:00:00" # Daily at 2:00 AM

    # Retention (uses repository defaults if not specified)
    # keep_daily: 7
    # keep_weekly: 4
    # keep_monthly: 3

    # Pruning
    prune: true

# ============================================================================
# Notes:
# - Backup runs as root for repository access
# - stdin_cmd uses sudo to run pg_dump as postgres user
# - pg_dump uses custom format (-Fc) with built-in compression
# - Retention: Uses repository defaults (7 daily, 4 weekly, 3 monthly)
# - Automatic pruning removes old snapshots per retention policy
# - systemd timer: /etc/systemd/system/restic-backup-testdb.timer
# - Generated scripts in /opt/restic/:
#   - backup-testdb.sh   (create backup)
#   - list-testdb.sh     (list snapshots)
#   - restore-testdb.sh  (restore from snapshot)
#   - list.sh            (all snapshots)
#   - check.sh           (verify repository)
# ============================================================================
