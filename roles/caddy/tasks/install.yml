---
# Caddy installation tasks

- name: Install required packages for repository management
  ansible.builtin.apt:
    name:
      - debian-keyring
      - debian-archive-keyring
      - apt-transport-https
      - curl
      - gpg
    state: present
    update_cache: true

- name: Download and install Caddy GPG key
  ansible.builtin.shell:
    cmd: curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
    creates: /usr/share/keyrings/caddy-stable-archive-keyring.gpg

- name: Set permissions on Caddy GPG keyring
  ansible.builtin.file:
    path: /usr/share/keyrings/caddy-stable-archive-keyring.gpg
    owner: root
    group: root
    mode: "0644"

- name: Add Caddy APT repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg] https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main"
    state: present
    filename: caddy-stable

- name: Pin Caddy version via APT preferences
  ansible.builtin.copy:
    content: |
      Package: caddy
      Pin: version {{ caddy_version }}.*
      Pin-Priority: 1000
    dest: /etc/apt/preferences.d/caddy
    mode: "0644"

- name: Install Caddy package
  ansible.builtin.apt:
    name: caddy
    state: present
    update_cache: true
