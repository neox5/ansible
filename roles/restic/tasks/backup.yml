---
# Backup configuration tasks

- name: Create backup-specific log directories
  ansible.builtin.file:
    path: "{{ restic_log_dir }}/{{ item.key }}"
    state: directory
    owner: "{{ restic_user }}"
    group: "{{ restic_user }}"
    mode: "0755"
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Deploy backup environment files
  ansible.builtin.template:
    src: environment.sh.j2
    dest: "{{ restic_script_dir }}/env-{{ item.key }}.sh"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  no_log: true

- name: Deploy repository-level list script
  ansible.builtin.template:
    src: list_all_script.sh.j2
    dest: "{{ restic_script_dir }}/list.sh"
    owner: root
    group: root
    mode: "0755"

- name: Deploy repository-level check script
  ansible.builtin.template:
    src: check_script.sh.j2
    dest: "{{ restic_script_dir }}/check.sh"
    owner: root
    group: root
    mode: "0755"

- name: Deploy backup scripts
  ansible.builtin.template:
    src: backup_script.sh.j2
    dest: "{{ restic_script_dir }}/backup-{{ item.key }}.sh"
    owner: root
    group: root
    mode: "0755"
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Deploy backup-level list scripts
  ansible.builtin.template:
    src: list_backup_script.sh.j2
    dest: "{{ restic_script_dir }}/list-{{ item.key }}.sh"
    owner: root
    group: root
    mode: "0755"
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Deploy backup-level restore scripts
  ansible.builtin.template:
    src: restore_script.sh.j2
    dest: "{{ restic_script_dir }}/restore-{{ item.key }}.sh"
    owner: root
    group: root
    mode: "0755"
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

- name: Deploy systemd service units
  ansible.builtin.template:
    src: restic.service.j2
    dest: "/etc/systemd/system/restic-backup-{{ item.key }}.service"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  notify: reload systemd

- name: Deploy systemd timer units
  ansible.builtin.template:
    src: restic.timer.j2
    dest: "/etc/systemd/system/restic-backup-{{ item.key }}.timer"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.value.schedule is defined
  notify: reload systemd

- name: Flush handlers to reload systemd
  ansible.builtin.meta: flush_handlers

- name: Enable and start systemd timers
  ansible.builtin.systemd:
    name: "restic-backup-{{ item.key }}.timer"
    enabled: "{{ item.value.schedule_enabled | default(restic_backup_schedule_enabled) }}"
    state: started
    daemon_reload: true
  loop: "{{ restic_backups | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.value.schedule is defined and (item.value.schedule_enabled | default(restic_backup_schedule_enabled))
