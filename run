#!/usr/bin/env bash
set -euo pipefail

_root_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

if [[ ! -f "${_root_dir}/run" ]]; then
  echo "error: run must be executed from within the repository" >&2
  exit 1
fi

if [[ -z "${BASH_VERSION:-}" ]]; then
  echo "error: bash is required" >&2
  exit 1
fi

source "${_root_dir}/scripts/lib/paths.sh"
source "${_root_dir}/scripts/lib/common.sh"
source "${_root_dir}/scripts/lib/verbs.sh"

usage() {
  printf "%s\n" \
    "Usage:" \
    "  run <component> <verb> [args]" \
    "" \
    "Components:" \
    "  sys" \
    "" \
    "Verbs:" \
    "  help, init, cleanup"
}

if [[ "${1:-}" == "help" || "${1:-}" == "-h" || "${1:-}" == "--help" || "${#}" -eq 0 ]]; then
  usage
  exit 0
fi

component="${1:-}"; shift || true
verb="${1:-}"; shift || true

[[ -n "${component}" ]] || die "missing component"
[[ -n "${verb}" ]] || die "missing verb"

component_file="${_root_dir}/scripts/components/${component}.sh"
[[ -f "$component_file" ]] || die "unknown component: ${component}"

source "$component_file"

[[ "${component_name:-}" == "${component}" ]] || \
  die "component spec mismatch: expected ${component}, got ${component_name:-<unset>}"

dispatch "$verb" "$@"
