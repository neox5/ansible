---
# PostgreSQL Database Restore
# Restores database from backup file using pg_restore
# Usage: ansible-playbook -i inventory/prod playbooks/postgresql_restore.yml -e "pg_restore_file=/path/to/backup.dump"
#        ansible-playbook -i inventory/prod playbooks/postgresql_restore.yml -e "pg_restore_file=/path/to/backup.dump pg_restore_database=mydb"

- name: Restore PostgreSQL database
  hosts: db
  become: yes
  gather_facts: yes

  vars:
    # Backup file to restore (must be provided via -e)
    pg_restore_file: ""

    # Target database name (override with -e, defaults to first configured database)
    pg_restore_database: "{{ postgresql_databases[0].name }}"

  tasks:
    - name: Validate restore file parameter
      ansible.builtin.fail:
        msg: "pg_restore_file parameter is required. Use: -e pg_restore_file=/path/to/backup.dump"
      when: pg_restore_file == ""

    - name: Verify backup file exists
      ansible.builtin.stat:
        path: "{{ pg_restore_file }}"
      register: restore_file

    - name: Fail if backup file does not exist
      ansible.builtin.fail:
        msg: "Backup file does not exist: {{ pg_restore_file }}"
      when: not restore_file.stat.exists

    - name: Display restore information
      ansible.builtin.debug:
        msg:
          - "Starting restore operation"
          - "Source file: {{ pg_restore_file }}"
          - "Target database: {{ pg_restore_database }}"
          - "File size: {{ restore_file.stat.size | human_readable }}"

    - name: Verify target database exists
      community.postgresql.postgresql_query:
        db: postgres
        query: "SELECT 1 FROM pg_database WHERE datname = '{{ pg_restore_database }}'"
      become_user: postgres
      register: db_check

    - name: Fail if target database does not exist
      ansible.builtin.fail:
        msg: "Target database '{{ pg_restore_database }}' does not exist. Create it first with postgresql_install.yml"
      when: db_check.query_result | length == 0

    - name: Restore database from backup
      community.postgresql.postgresql_db:
        name: "{{ pg_restore_database }}"
        state: restore
        target: "{{ pg_restore_file }}"
      become_user: postgres
      register: restore_result

    - name: Display restore completion
      ansible.builtin.debug:
        msg: "Restore completed successfully for database: {{ pg_restore_database }}"
