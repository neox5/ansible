---
- name: "Stage 2: Deploy n8n Application"
  hosts: n8n
  become: true

  pre_tasks:
    - name: Verify PostgreSQL is running (preflight)
      ansible.builtin.systemd_service:
        name: postgresql
      register: pg_status
      failed_when: pg_status.status.ActiveState != "active"

  tasks:
    - name: Display stage information
      ansible.builtin.debug:
        msg: "Deploying n8n workflow automation container..."

    - name: Deploy n8n role
      ansible.builtin.include_role:
        name: n8n

    - name: Wait for n8n port to be available
      ansible.builtin.wait_for:
        host: "{{ n8n_db_host }}"
        port: "{{ n8n_port }}"
        delay: 5
        timeout: "{{ n8n_port_wait_timeout }}"
        msg: "Timeout waiting for n8n port {{ n8n_port }}"

    - name: Wait for n8n readiness endpoint
      ansible.builtin.uri:
        url: "http://{{ n8n_db_host }}:{{ n8n_port }}/healthz/readiness"
        status_code: 200
        timeout: 10
      register: n8n_readiness_check
      until: n8n_readiness_check.status == 200
      retries: "{{ n8n_readiness_retries }}"
      delay: "{{ n8n_readiness_delay }}"

    - name: Display n8n deployment summary
      ansible.builtin.debug:
        msg:
          - "âœ“ n8n deployment complete"
          - "Version: {{ n8n_version }}"
          - "URL: http://{{ n8n_db_host }}:{{ n8n_port }}"
          - "Health: Passing (connected to database)"
          - "Status: Ready for use"
