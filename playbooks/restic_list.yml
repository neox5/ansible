---
# Restic List Snapshots
# Display all snapshots or snapshots for specific backup
# Usage: ansible-playbook -i inventory/lab playbooks/restic_list.yml --limit lab-vm
#        ansible-playbook -i inventory/lab playbooks/restic_list.yml --limit lab-vm -e "backup_name=testdb"

- name: List Restic snapshots
  hosts: all
  become: yes

  vars:
    backup_name: "" # Empty = all snapshots, or specify specific backup

  tasks:
    - name: List all snapshots
      ansible.builtin.command:
        cmd: "{{ restic_script_dir }}/list.sh"
      register: list_all
      when: backup_name == ""

    - name: List snapshots for specific backup
      ansible.builtin.command:
        cmd: "{{ restic_script_dir }}/list-{{ backup_name }}.sh"
      register: list_backup
      when: backup_name != ""

    - name: Display all snapshots
      ansible.builtin.debug:
        var: list_all.stdout_lines
      when: backup_name == ""

    - name: Display backup-specific snapshots
      ansible.builtin.debug:
        var: list_backup.stdout_lines
      when: backup_name != ""
