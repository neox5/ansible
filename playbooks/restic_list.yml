---
# Restic List Snapshots
# Display all snapshots in configured repositories
# Usage: ansible-playbook -i inventory/lab playbooks/restic_list.yml --limit lab-vm
#        ansible-playbook -i inventory/lab playbooks/restic_list.yml --limit lab-vm -e "repo_name=local"

- name: List Restic snapshots
  hosts: all
  become: yes

  vars:
    repo_name: "" # Empty = all repos, or specify specific repo

  tasks:
    - name: List snapshots in all repositories
      ansible.builtin.command:
        cmd: "restic snapshots"
      environment:
        RESTIC_REPOSITORY: "{{ item.value.location }}"
        RESTIC_PASSWORD: "{{ item.value.password }}"
      become_user: "{{ restic_user }}"
      loop: "{{ restic_repos | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      register: snapshots_all
      failed_when: false
      when: repo_name == ""

    - name: List snapshots in specific repository
      ansible.builtin.command:
        cmd: "restic snapshots"
      environment:
        RESTIC_REPOSITORY: "{{ restic_repos[repo_name].location }}"
        RESTIC_PASSWORD: "{{ restic_repos[repo_name].password }}"
      become_user: "{{ restic_user }}"
      register: snapshots_specific
      when: repo_name != ""

    - name: Display snapshots grouped by repository
      ansible.builtin.debug:
        msg: |
          Repository: {{ item.item.key }}
          {{ item.stdout }}
      loop: "{{ snapshots_all.results }}"
      loop_control:
        label: "{{ item.item.key }}"
      when: repo_name == ""

    - name: Display snapshots for specific repository
      ansible.builtin.debug:
        var: snapshots_specific.stdout_lines
      when: repo_name != ""
