---
# Restic Database Restore
# Restore from Restic snapshot (stdin backups only)
# Usage: ansible-playbook -i inventory/lab playbooks/restic_restore.yml --limit lab-vm
#        ansible-playbook -i inventory/lab playbooks/restic_restore.yml --limit lab-vm -e "snapshot_id=abc123def"
#        ansible-playbook -i inventory/lab playbooks/restic_restore.yml --limit lab-vm -e "backup_name=testdb"

- name: Restore from Restic snapshot
  hosts: all
  become: yes

  vars:
    backup_name: "{{ restic_backups.keys() | first }}" # Default to first backup
    snapshot_id: "latest"
    restore_database: "{{ backup_name }}" # Assumes database name matches backup name

  tasks:
    - name: Validate backup is stdin mode
      ansible.builtin.assert:
        that:
          - restic_backups[backup_name].stdin | default(false)
        fail_msg: "Backup '{{ backup_name }}' must be stdin mode for database restore"

    - name: Restore database from snapshot
      ansible.builtin.shell:
        cmd: "{{ restic_script_dir }}/restore-{{ backup_name }}.sh {{ snapshot_id }} | sudo -u postgres {{ postgresql_scripts_dir | default('/usr/local/bin') }}/pg_restore.sh -y /dev/stdin {{ restore_database }}"
      register: restore_result

    - name: Display restore output
      ansible.builtin.debug:
        var: restore_result.stdout_lines
