---
- name: Bootstrap server for Ansible management
  hosts: all
  gather_facts: no
  become: yes

  tasks:
    - name: Check Python is installed
      raw: command -v python3
      register: python_check
      changed_when: false
      failed_when: false

    - name: Install Python if missing
      raw: |
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update && apt-get install -y python3
        else
          echo "Unsupported package manager" >&2
          exit 1
        fi
      when: python_check.rc != 0
      changed_when: true

    - name: Gather facts after Python installed
      setup:

    - name: Configure Debian network repositories
      block:
        - name: Remove CD-ROM source from sources.list
          ansible.builtin.lineinfile:
            path: /etc/apt/sources.list
            regexp: "^deb cdrom:"
            state: absent

        - name: Configure main Debian repositories
          ansible.builtin.copy:
            dest: /etc/apt/sources.list
            content: |
              # Debian Trixie (13) - Main repositories
              deb http://deb.debian.org/debian trixie main contrib non-free-firmware
              deb-src http://deb.debian.org/debian trixie main contrib non-free-firmware

              # Security updates
              deb http://deb.debian.org/debian-security trixie-security main contrib non-free-firmware
              deb-src http://deb.debian.org/debian-security trixie-security main contrib non-free-firmware

              # Stable updates
              deb http://deb.debian.org/debian trixie-updates main contrib non-free-firmware
              deb-src http://deb.debian.org/debian trixie-updates main contrib non-free-firmware
            owner: root
            group: root
            mode: "0644"
      when: ansible_distribution == "Debian"

    - name: Install sudo if missing
      package:
        name: sudo
        state: present

    - name: Create ansible user
      user:
        name: "{{ bootstrap_ansible_user }}"
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Create admin user
      user:
        name: "{{ bootstrap_admin_user }}"
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Create .ssh directory for ansible user
      file:
        path: "/home/{{ bootstrap_ansible_user }}/.ssh"
        state: directory
        owner: "{{ bootstrap_ansible_user }}"
        group: "{{ bootstrap_ansible_user }}"
        mode: "0700"

    - name: Create .ssh directory for admin user
      file:
        path: "/home/{{ bootstrap_admin_user }}/.ssh"
        state: directory
        owner: "{{ bootstrap_admin_user }}"
        group: "{{ bootstrap_admin_user }}"
        mode: "0700"

    - name: Add automation SSH keys to ansible user
      authorized_key:
        user: "{{ bootstrap_ansible_user }}"
        key: "{{ item }}"
        state: present
      loop: "{{ bootstrap_ansible_keys }}"

    - name: Add admin SSH keys to admin user
      authorized_key:
        user: "{{ bootstrap_admin_user }}"
        key: "{{ item }}"
        state: present
      loop: "{{ bootstrap_admin_keys }}"

    - name: Configure temporary passwordless sudo for ansible user
      copy:
        content: "{{ bootstrap_ansible_user }} ALL=(ALL) NOPASSWD:ALL\n"
        dest: "/etc/sudoers.d/00-ansible-bootstrap"
        mode: "0440"
        validate: "visudo -cf %s"

    - name: Configure temporary passwordless sudo for admin user
      copy:
        content: "{{ bootstrap_admin_user }} ALL=(ALL) NOPASSWD:ALL\n"
        dest: "/etc/sudoers.d/00-admin-bootstrap"
        mode: "0440"
        validate: "visudo -cf %s"

    - name: Verify ansible user can sudo
      command: sudo -n -l
      become: yes
      become_user: "{{ bootstrap_ansible_user }}"
      changed_when: false

    - name: Verify admin user can sudo
      command: sudo -n -l
      become: yes
      become_user: "{{ bootstrap_admin_user }}"
      changed_when: false

    - name: Remove temporary user
      user:
        name: "{{ bootstrap_temp_user }}"
        state: absent
        remove: yes
        force: yes
      when: bootstrap_temp_user is defined and bootstrap_temp_user != ""

    - name: Display next steps
      debug:
        msg:
          - "Bootstrap complete!"
          - ""
          - "Root account: Locked (no password, use admin user for console access)"
          - ""
          - "Automation access:"
          - "  ssh -i ~/.ssh/id_ed25519_ansible {{ bootstrap_ansible_user }}@{{ inventory_hostname }}"
          - ""
          - "Operator access (admin):"
          - "  ssh -i ~/.ssh/id_ed25519_desktop {{ bootstrap_admin_user }}@{{ inventory_hostname }}"
          - "  ssh -i ~/.ssh/id_ed25519_mobile {{ bootstrap_admin_user }}@{{ inventory_hostname }}"
          - ""
          - "Emergency access:"
          - "  ssh -i ~/.ssh/id_ed25519_emergency {{ bootstrap_admin_user }}@{{ inventory_hostname }}"
          - ""
          - "Temporary user removed: {{ bootstrap_temp_user }}"
          - "Root SSH access: Prohibited (console access via admin user)"
          - ""
          - "Next: Apply security hardening"
          - "  ansible-playbook -i inventory/prod playbooks/site.yml --tags security_hardening"
